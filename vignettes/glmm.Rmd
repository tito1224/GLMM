---
title: "Fitting a Poisson GLMM to Epilepsy Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting a Poisson GLMM to Epilepsy Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(GLMM)
library(dplyr)
library(ggplot2)
```

## Introduction
Generalized linear mixed effects models (GLMMs) using a Poisson distribution are extremely useful to model count-based data while also accounting for sources of random variation. The GLMM package contains functions that makes likelihood-based parameter inferences to summarize the Poisson GLMM distribution for a given data set, which includes features such as estimations of the parameter values, as well as their standard errors and confidence intervals. This document introduces you to GLMM's useful tools to help understand the Poisson distribution.

## Exploratory Data Analysis
The `epilepsy.csv` data set is based on a clinical trial that. We can visualize the data by outputting the first 10 rows.
```{r}
epilepsy <- read.csv("./data-raw/epilepsy.csv")
head(epilepsy, 10)
```
The first measurement contains the total number of seizures during the baseline period. The following four measurements contain the number of seizures during the trial period, which is recorded as 4 separate two-week periods.

### Data Processing
Based on the data analysis, there were 5 measurements for each subject. However, there should be *m* = 2 measurements per subject, so we must summarize the measurements conducted during the trial period by summing up the number of seizures for each individual subject where **expind** is equal to 1.
```{r data cleaning}
epilepsy <- epilepsy %>%
  group_by(id,treat,expind,age) %>%
  summarize(seizures = sum(seizures),
            .groups = "drop")
```

We can also understand the forms of each variable with `str()`. This will output each predictor's data types, along with the possible values they can take on.
```{r str}
str(epilepsy)
```

Based on the results, **treat** and **expind** are integer data types. However, they should be a categorical variable. Therefore, we can use factor them into two levels, 1 or 0, which is shown below:
```{r factor}
epilepsy$treat <- as.factor(epilepsy$treat)
epilepsy$expind <- as.factor(epilepsy$expind)
```

### Data Visualization
After cleaning the data, we will visualize it by using graphical methods to get a sense of how the data is distributed. This can be done by plotting the counts of data using `ggplot()`. The data can be split into two plots for the baseline and trial groups, as well as categorize the histogram plot line colours based on the two treatment groups, drug or placebo.
```{r plot1}
ggplot(epilepsy, aes(x=seizures, color=treat)) + geom_histogram(fill="white", alpha=0.5, position="identity") + facet_wrap(~expind) + ggtitle("Number of Seizures for Baseline and Trial Groups")
```
The number of seizures recorded for the baseline period seem to be generally greater, but solely relying on data visualization will not be enough to make accurate statistical conclusions. Therefore, we can use functions within the GLMM package to make further inferences by fitting a Poisson GLMM to the data.

## Fitting the Model
### Point Estimates with `run_model()`
We can use the `run_model()` function in the GLMM package to obtain the point estimates for $\beta_0$, the $\hat{\beta}$'s, and $\hat{\sigma}^2$. This function accepts two arguments:

* The first argument, *data*, accepts a data set
* The second argument, *example*, accepts a string value which specifies the name of the chosen data set

The results for the point estimates are outputted below:
```{r fit}
epilepsy_fit <- run_model(epilepsy, "epilepsy")
epilepsy_fit$beta #output beta estimates
epilepsy_fit$sigmasq #output sigma estimate
```

### Standard Errors with `btsp()`
To obtain the standard errors for all the parameters, we can use the `btsp()` function in the GLMM package. This function accepts the same two arguments as `run_model()`, and uses the point estimates computed from that same function.
``` {r btsp}
btsp(epilepsy, example="epilepsy")
```

### Confidence Intervals with `ci()`
Similarly, the `ci()` function in the package computes the confidence intervals for all the parameters. This function accepts the same arguments as `run_model()` and `btsp()`, and uses both the point estimates and standard errors from those functions respectively to calculate the confidence intervals.
```{r ci}
ci(epilepsy, example="epilepsy")
```

## Hypothesis Test
We can use the following hypothesis statements to make conclusions about the drug's effectiveness to significantly reduce the number of seizures a patient experiences after accounting for age:
$$H_0: \beta_2 = 0$$
$$H_a: \beta_2 < 0$$
We may reject the null hypothesis if the t-test statistic is less than the critical value. The critical value uses the Student's t-distribution with $\nu =n-1$ degrees of freedom and a significance level of $\alpha = 0.5$. Since *n* = 59 subjects, we can find the critical value by using the `qt()` function:
```{r }
qt(p=.05, df=58, lower.tail=T)
```

We can use the results from `run_model()`, as it includes the test statistic values for all the parameters. We are interested in the test statistic for $\beta_2$, denoted by **expind:treat** in the fitted model. We must compare the test statistic with the critical value. If the test statistic is less than the critical value, we are able to reject the null hypothesis, indicating a significant reduction in the number of seizures after taking the drug. Otherwise, the null hypothesis holds true and we may assume that there is no significant reduction in the number of seizures after taking the drug.
```{r}
epilepsy_fit$test_stat
```
Since the test statistic -1.6572965 is greater than the critical value -1.671553, we do not reject the null hypothesis. In conclusion, the drug does not significantly reduce the number of seizures after accounting for age. 
