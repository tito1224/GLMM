---
title: "Fitting a Poisson GLMM to Epilepsy Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting a Poisson GLMM to Epilepsy Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(GLMM)
library(dplyr)
library(ggplot2)
```

## Introduction
Generalized linear mixed effects models (GLMMs) using a Poisson distribution are extremely useful to model count-based data while also accounting for sources of random variation. The GLMM package contains functions that makes likelihood-based parameter inferences to summarize the Poisson GLMM distribution for a given data set, which includes features such as estimations of the parameter values, as well as their standard errors and confidence intervals. This document introduces you to GLMM's useful tools to help understand the Poisson distribution.

## Exploratory Data Analysis
The `epilepsy.csv` data set is based on a clinical trial that. We can visualize the data by outputting the first 10 rows.
```{r}
epilepsy <- read.csv("./data-raw/epilepsy.csv")
head(epilepsy, 10)
```
The first measurement contains the total number of seizures during the baseline period. The following four measurements contain the number of seizures during the trial period, which is recorded as 4 separate two-week periods.

### Data Processing
Based on the data analysis, there were 5 measurements for each subject. However, there should be *m* = 2 measurements per subject, so we must summarize the measurements conducted during the trial period by summing up the number of seizures where **expind** is equal to 1.
```{r data cleaning}
epilepsy <- epilepsy %>%
  group_by(id,treat,expind,age) %>%
  summarize(seizures = sum(seizures),
            .groups = "drop")
```

We can also understand the forms of each variable with `str()`. This will output each predictor's data types, along with the possible values they can take on.
```{r str}
str(epilepsy)
```

Based on the results, **treat** and **expind** are integer data types. However, they should be a categorical variable. Therefore, we can use factor them into two levels, 1 or 0, which is shown below:
```{r factor}
epilepsy$treat <- as.factor(epilepsy$treat)
epilepsy$expind <- as.factor(epilepsy$expind)
```

### Data Visualization
After cleaning the data, we can visualize it using graphical methods to get a sense of how the data is distributed. We can plot the counts of data using `ggplot()`. They can be split into two plots for baseline and trial period groups, colour-coded based on the two treatment groups, drug or placebo.
```{r plot1}
ggplot(epilepsy, aes(x=seizures, color=treat)) + geom_histogram(fill="white", alpha=0.5, position="identity") + facet_wrap(~expind) + ggtitle("Number of Seizures for Baseline and Trial Groups")
```
The number of seizures recorded for the baseline period seem to be generally greater, but the histogram is not enough to make accurate statistical conclusions. Thus, we can use functions within this GLMM package to make further inferences of the model's fit to the data.

## Fitting the Model
We can use the function `run_model` in the GLMM package to obtain the point estimates for the $\hat{\beta}$'s $\hat{\sigma}^2$, $z_i$'s, and test statistics for the parameters. To obtain the standard errors for all the parameters, we can also use `btsp()`. The confidence intervals can be computed through the function `ci()` in this package.
```{r fit}
epilepsy_fit <- run_model(epilepsy, "epilepsy")
epilepsy_fit$beta #compute beta estimates
btsp(epilepsy, example="epilepsy")
ci(epilepsy, example="epilepsy")
```

## Hypothesis Test
We can use the following hypothesis statements to make conclusions about the drug's ability to significantly reduce the number of seizures a patient experiences after accounting for age:
$$H_0: \beta_2 = 0$$ 
$$H_a: \beta_2 < 0$$
We can reject the null hypothesis if the t-test statistic is less than the critical value. The critical value $\beta_2$ uses degrees of freedom $n-1$ and $\alpha = 0.5$:
```{r }
qt(p=.05, df=58, lower.tail=T)
```

We can use the output from `run_model()`, as it includes the test statistics for all parameters. We are looking at $\beta_2$, denoted by **expind:treat**. We must compare with the t-test statistic of 
```{r}
epilepsy_fit$test_stat
```
Since -1.6572965 is greater than -1.671553, we do not reject the null hypothesis. In conclusion,
